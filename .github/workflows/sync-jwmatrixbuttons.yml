name: Sync JWMatrixButtons + Auto Release

on:
  push:
    branches: [ "main" ]
    paths:
      - "libraries/JWMatrixButtons/**"

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Configure git identity
        run: |
          git config user.name "jw-control-bot"
          git config user.email "jw.control.peru@gmail.com"

      - name: Extract version from library.properties
        id: ver
        run: |
          VERSION=$(grep '^version=' libraries/JWMatrixButtons/library.properties | cut -d'=' -f2 | tr -d '\r' | xargs)
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected VERSION=$VERSION"

      - name: Add distribution remote (token)
        run: |
          git remote remove dist 2>/dev/null || true
          git remote add dist https://x-access-token:${{ secrets.DIST_PUSH_TOKEN }}@github.com/JW-Control/JWMatrixButtons.git
          git remote -v

      - name: Subtree split
        run: |
          git subtree split --prefix=libraries/JWMatrixButtons -b split-jwmatrixbuttons

      - name: Push subtree to subrepo
        run: |
          git push dist split-jwmatrixbuttons:main --force

      - name: Check if tag already exists in subrepo
        id: tagcheck
        run: |
          git ls-remote --tags dist v${{ steps.ver.outputs.VERSION }} | grep -q "refs/tags/v${{ steps.ver.outputs.VERSION }}$" \
            && echo "EXISTS=true" >> $GITHUB_OUTPUT \
            || echo "EXISTS=false" >> $GITHUB_OUTPUT

      - name: Create Git tag in subrepo (only if missing)
        if: steps.tagcheck.outputs.EXISTS == 'false'
        run: |
          git push dist split-jwmatrixbuttons:refs/tags/v${{ steps.ver.outputs.VERSION }}

      - name: Create GitHub Release in subrepo (only if missing)
        if: steps.tagcheck.outputs.EXISTS == 'false'
        uses: softprops/action-gh-release@v2
        with:
          repository: JW-Control/JWMatrixButtons
          tag_name: v${{ steps.ver.outputs.VERSION }}
          name: JWMatrixButtons v${{ steps.ver.outputs.VERSION }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.DIST_PUSH_TOKEN }}
